<%inherit file="shopping_cart_flow.html" />
<%namespace name='static' file='/static_content.html'/>
<%!
from django.utils.translation import ugettext as _
from django.core.urlresolvers import reverse
%>

<%block name="billing_details_highlight"><li class="active" >${_('Billing Details')}</li></%block>
<%block name="confirmation_highlight"></%block>
<link rel="stylesheet" href="${static.url('custom_css/intlTelInput.css')}">
<link rel="stylesheet" href="${static.url('custom_css/countrySelect.css')}">

<%block name="custom_content">
<div class="container">

  % if shoppingcart_items:
    <%
      order_type = 'abc'
    %>
  <section class="confirm-enrollment shopping-cart billing-details-view">
      <h3>${_('You can proceed to payment at any point in time. Any additional information you provide will be included in your receipt.')}</h3>
      <div class="billing-data">
       
        % if order_type == 'business':
          <div class="col-half">
            <h3>${_('Purchasing Organizational Details')}</h3>
            <div class="data-group"><label for="id_company_name">${_('Purchasing organization')}</label><input type="text" id="id_company_name" name="company_name"></div>
          <div class="data-group"><label for="id_customer_reference_number">${_('Purchase order number (if any)')}</label><input type="text" id="id_customer_reference_number" maxlength="63" name="customer_reference_number"></div>
          </div>
          <div class="col-half">
            <h3>${_('Organization Contact')}</h3>
            <div class="data-group"><label for="id_company_contact_name">${_('Name')}</label><input type="text"id="id_company_contact_name" name="company_contact_name"></div>
            <div class="data-group"><label for="id_company_contact_email">${_('Email Address')}</label><input type="email" placeholder="${_('email@example.com')}" id="id_company_contact_email" name="company_contact_email"><span id="company_contact_email_error" class="error-text"></span></div>
          </div>
          <div class="col-half">
            <h3>${_('Additional Receipt Recipient')}</h3>
            <div class="data-group">
              <label for="id_recipient_name">${_('Name')}</label>
           <input type="text" id="id_recipient_name" name="recipient_name">
           </div>
           <div class="data-group">
             <label for="id_recipient_email">${_('Email Address')}</label>
             <input type="email" id="id_recipient_email" placeholder="${_('email@example.com')}" name="recipient_email">
             <span id="recipient_email_error" class="error-text"></span>
           </div>
          </div>
        % endif
        <div class="col-half">
          <div class="data-group">
            <label for="id_first_name">${_('Full Name')} *</label>
            <input type="text"id="id_first_name" name="cc_full_name" value="${parmas.get('cc_full_name', '')}" required="required">

            <span id="error_first_name" class="error-text"></span>
          </div>
          <div class="data-group ${LANGUAGE_CODE}">
            <label for="id_phone_number">${_('Phone Number')} *</label>
            <input type="tel" id="phone" name="phone_number">
            <span id="error_phone_number" class="error-text"></span>
          </div>
        </div>
        <div class="col-half">
          <div class="data-group">
            <script type="text/javascript" src="${static.url('js/countrySelect.js')}"></script>
            <label for="id_billing_address">${_('Country')} *</label>
            <select  id="country" name="country"></select> 
            <span id="error_billing_address" class="error-text"></span>
          </div>
          <div class="data-group">
            <label for="id_city">${_('City')} *</label>
            <input type="text" id="id_city" name="city" value="${parmas.get('city', '')}" required="required">
            <span id="error_city" class="error-text"></span>
          </div>
          <div class="data-group hidden">  
            <input type="text" id="id_city" name="postal_code" value="${parmas.get('postal_code', '')}" >
          </div>
         
        </div>
      </div>
    <div class="discount">
      <div class="code-text">
          <span class="pull-right">${_('Total')}: <b>${"{0:0.2f}".format(amount)} ${currency.upper()}</b></span>
      </div>
      </div>
      <div class="col-two">
          <div class="col-2">
               ${form_html}
          </div>
      </div>
      <div class="disclaimer">${_('Payment processing occurs on a separate secure site.')}</div>
  </section>
  %else:
  <div class="empty-cart" >
        <h2>${_('Your Shopping cart is currently empty.')}</h2>
          <a href="${marketing_link('COURSES')}" class="blue">${_('View Courses')}</a>
  </div>
  %endif
</div>
</%block>
<script src="${static.url('js/intlTelInput.js')}"></script>

<script>
$( document ).ready(function() {


    x = ${countries}
    for (var i =0; i < x.length; i++) {
       $("#country").append("<option value=" +x[i][0] + ">"+x[i][1]+"</option>")
    }
$("#country").css("width","463px")
$("#country").css("background","white")
y = "${selected_country}"
x=$('#country option[value=' + y +']')
x.attr("selected","selected")
})


  $(function() {
    // $("#phone").intlTelInput("setNumber", "+917878787878");
    var phoneNumber = "${str(parmas.get('cc_phone_number', '')) + str(parmas.get('phone_number', ''))}"
    $("#phone").intlTelInput({
        nationalMode: false,
        separateDialCode: true,
        initialCountry: "auto",
        geoIpLookup: function(callback) {
            $.get('https://ipinfo.io', function() {}, "jsonp").always(function(resp) {
                var countryCode = (resp && resp.country) ? resp.country : "";
                callback(countryCode);
            });
        },
        utilsScript: "${static.url('js/country_utils.js')}"
    });
    $("#phone").intlTelInput("setNumber", phoneNumber);

    function validateEmail(sEmail) {
      filter = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/
      return filter.test(sEmail)
     }
    $('section.confirm-enrollment form button[type="submit"]').click(function(event) {
      var is_valid_email = true;

      var payment_form = $(this).parent('form');
      programs = ${programs}
      if (programs == true){
      payment_form.prepend("<input type='hidden' name='programs'></input> ")
   }
      var recipient_email = $('input[name="recipient_email"]').val();
      var company_contact_email =  $('input[name="company_contact_email"]').val();

      var cc_full_name = $('input[name="cc_full_name"]').val();

      // var cc_last_name = $('input[name="cc_last_name"]').val();
      var country_code = '+'
      var billing_address = $('input[name="billing_address"]').val();
      var city = $('input[name="city"]').val();
      var postal_code = $('input[name="postal_code"]').val();
      var country=$('#country').val();
      var phone_number = $("#phone").intlTelInput("getNumber");
      country_code = country_code + $("#phone").intlTelInput("getSelectedCountryData").dialCode;
      phone_number = phone_number.replace(country_code, "");


      
      if (! cc_full_name){
         $('span#error_first_name').html('Please enter your full name');
         $('input[name="cc_full_name"]').addClass('error');
         is_valid_email = false;
      } else {
         $('input[name="cc_full_name"]').removeClass('error');
         $('span#error_full_name').html('');

      }
      
      if (! phone_number){
         $('span#error_phone_number').html('Please enter phone number');
         $('input[name="phone_number"]').addClass('error');
         is_valid_email = false;
      } else {
         $('input[name="phone_number"]').removeClass('error');
         $('span#error_phone_number').html('');
      }
      
      if (! city){
         $('span#error_city').html('Please enter city');
         $('input[name="city"]').addClass('error');
         is_valid_email = false;
      } else {
         $('input[name="city"]').removeClass('error');
         $('span#error_city').html('');
      }
      
      if ( recipient_email != undefined && recipient_email != '' && !(validateEmail(recipient_email))) {
         $('span#recipient_email_error').html('Please enter valid email address');
         $('input[name="recipient_email"]').addClass('error');
        is_valid_email = false;
      }
      else {
        $('input[name="recipient_email"]').removeClass('error');
        $('span#recipient_email_error').html('');
      }
      if ( company_contact_email != undefined && company_contact_email != '' && !(validateEmail(company_contact_email))) {
         $('span#company_contact_email_error').html('Please enter valid email address');
        $('input[name="company_contact_email"]').addClass('error');
        is_valid_email = false;
      }
      else {
        $('input[name="company_contact_email"]').removeClass('error');
        $('span#company_contact_email_error').html('');
      }
      if (!is_valid_email) {
        return false;
      }
      event.preventDefault();
      // Disable the submit button to prevent duplicate submissions
      $(this).addClass("disabled");
      var post_url = "${reverse('billing_details')}";
      var data = {
          "company_name" : $('input[name="company_name"]').val(),
          "company_contact_name" : $('input[name="company_contact_name"]').val(),
          "company_contact_email" : company_contact_email,
          "recipient_name" : $('input[name="recipient_name"]').val(),
          "recipient_email" : recipient_email,
          "customer_reference_number" : $('input[name="customer_reference_number"]').val(),
          "cc_full_name": cc_full_name,
          "country":country,
          "country_code": country_code,
          "phone_number": phone_number,
          "billing_address": billing_address,
          "city": city,
      };
      $.post(post_url, data)
      .done(function(data) {
            if (data.is_course_enrollment_closed == true) {
              location.href = "${reverse('shoppingcart.views.show_cart')}";
            } else {
              payment_form.submit();
            }
            })
      .error(function(data,status) {
            $(this).removeClass("disabled");
      });
    });

})

</script>

